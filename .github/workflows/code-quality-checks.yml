name: "ðŸ”Ž Code Quality Checks"

permissions:
  statuses: write

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      sha:
        type: string
        required: false
      branch_name:
        type: string
        required: false

jobs:
  code-quality-checks:
    name: "ðŸ›¡ï¸ Quality Gate"
    runs-on: ubuntu-latest
    env:
      CI_COMMIT_BRANCH: ${{ inputs.branch_name || github.ref_name }}
    steps:
      - name: Set Pending Status
        uses: guibranco/github-status-action-v2@v1.1.13
        with:
          authToken: ${{ github.token }}
          context: "Quality Gate (Status checks)"
          state: "pending"
          sha: ${{ inputs.sha || github.sha }}
          description: "Analysis is running..."
          target_url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          ref: ${{ inputs.sha || github.ref }}

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Gradle Lint, Tests, and ktlint Checks
        run: |
          echo "Testing branch: $CI_COMMIT_BRANCH"
          echo "Running on SHA: ${{ inputs.sha || github.sha }}"
          ./gradlew --continue lintDebug test ktlintCheck --stacktrace

      - name: Generate Test Summary
        if: always()
        run: |
          echo "# ðŸ”Ž Code Quality Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** $CI_COMMIT_BRANCH" >> $GITHUB_STEP_SUMMARY
          echo "**SHA:** ${{ inputs.sha || github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Test Results Summary
          echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count test results
          TOTAL_TESTS=0
          PASSED_TESTS=0
          FAILED_TESTS=0
          SKIPPED_TESTS=0

          for file in $(find . -path "*/build/test-results/*/TEST-*.xml" 2>/dev/null); do
            if [ -f "$file" ]; then
              TESTS=$(grep -oP 'tests="\K[0-9]+' "$file" | head -1 || echo "0")
              FAILURES=$(grep -oP 'failures="\K[0-9]+' "$file" | head -1 || echo "0")
              SKIPPED=$(grep -oP 'skipped="\K[0-9]+' "$file" | head -1 || echo "0")

              TOTAL_TESTS=$((TOTAL_TESTS + TESTS))
              FAILED_TESTS=$((FAILED_TESTS + FAILURES))
              SKIPPED_TESTS=$((SKIPPED_TESTS + SKIPPED))
            fi
          done

          PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS - SKIPPED_TESTS))

          if [ $TOTAL_TESTS -eq 0 ]; then
            echo "âš ï¸ No tests found" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $PASSED_TESTS |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAILED_TESTS |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Skipped | $SKIPPED_TESTS |" >> $GITHUB_STEP_SUMMARY
            echo "| **ðŸ“Š Total** | **$TOTAL_TESTS** |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Lint Results Summary
          echo "## ðŸ” Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "app/lint-report.xml" ]; then
            LINT_ERRORS=$(grep -oP 'severity="Error"' app/lint-report.xml | wc -l || echo "0")
            LINT_WARNINGS=$(grep -oP 'severity="Warning"' app/lint-report.xml | wc -l || echo "0")
            LINT_INFO=$(grep -oP 'severity="Information"' app/lint-report.xml | wc -l || echo "0")

            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”´ Errors | $LINT_ERRORS |" >> $GITHUB_STEP_SUMMARY
            echo "| âš ï¸ Warnings | $LINT_WARNINGS |" >> $GITHUB_STEP_SUMMARY
            echo "| â„¹ï¸ Info | $LINT_INFO |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Lint report not found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download detailed reports from the artifacts section below:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ **lint-reports-html** - Android Lint HTML reports" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **unit-test-reports-html** - Unit test HTML reports" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‹ **ktlint-reports-html** - ktlint code style reports" >> $GITHUB_STEP_SUMMARY

      - name: Set Final Status
        if: always()
        uses: guibranco/github-status-action-v2@v1.1.13
        with:
          authToken: ${{ github.token }}
          context: "Quality Gate (Status checks)"
          state: ${{ job.status }}
          sha: ${{ inputs.sha || github.sha }}
          description: "Analysis finished with status: ${{ job.status }}"
          target_url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Upload Lint Reports (HTML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports-html
          path: |
            app/lint-report.html
            **/build/reports/lint-results-*.html
          retention-days: 7

      - name: Upload Lint Reports (XML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports-xml
          path: app/lint-report.xml
          retention-days: 7


      - name: Upload Unit Test Results (XML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results-xml
          path: '**/build/test-results/**/TEST-*.xml'
          retention-days: 7

      - name: Upload Unit Test Reports (HTML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-reports-html
          path: '**/build/reports/tests/**'
          retention-days: 7

      - name: Upload ktlint Reports (XML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ktlint-reports-xml
          path: '**/build/reports/ktlint/**/*.xml'
          retention-days: 7

      - name: Upload ktlint Reports (HTML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ktlint-reports-html
          path: '**/build/reports/ktlint/**/*.html'
          retention-days: 7

